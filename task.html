<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Room - Task28 Elite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gold: #D4AF37;
            --bg-dark: #0f0f0f;
            --card-bg: #1a1a1a;
            --text-white: #ffffff;
            --text-gray: #b0b0b0;
            --danger: #ff4d4d;
            --success: #00ff88;
            --warning: #ffb700;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-white); padding-bottom: 50px; }

        /* Header */
        .header { display: flex; align-items: center; padding: 15px 20px; background: rgba(20, 20, 20, 0.95); border-bottom: 1px solid rgba(212, 175, 55, 0.2); position: sticky; top: 0; z-index: 100; }
        .back-btn { color: #fff; font-size: 1.2rem; margin-right: 15px; text-decoration: none; }
        .title { font-size: 1.1rem; font-weight: 700; color: var(--primary-gold); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-val { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.75rem; color: var(--text-gray); text-transform: uppercase; }
        .s-success { color: var(--success); border-bottom: 2px solid var(--success); }
        .s-failed { color: var(--danger); border-bottom: 2px solid var(--danger); }
        .s-pending { color: var(--warning); border-bottom: 2px solid var(--warning); }
        .s-missing { color: #888; border-bottom: 2px solid #888; }

        /* Task Area */
        .task-container { margin: 0 20px; min-height: 400px; position: relative; }

        /* State: Idle (Apply Button) */
        #applySection { text-align: center; padding-top: 50px; }
        .apply-btn {
            background: linear-gradient(135deg, #D4AF37, #B8860B);
            color: #000; border: none; padding: 15px 40px; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            transition: 0.3s;
        }
        .apply-btn:active { transform: scale(0.95); }
        .loader-text { margin-top: 20px; color: var(--primary-gold); display: none; }

        /* State: Active Task */
        #activeTaskSection { display: none; background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--primary-gold); }
        
        /* Timer */
        .timer-box { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #2a2a2a; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; 
            border: 1px solid var(--danger);
        }
        .timer-label { font-size: 0.9rem; color: #fff; }
        .timer-count { font-size: 1.2rem; font-weight: bold; color: var(--danger); font-family: monospace; }

        /* Data Fields */
        .data-row { 
            display: flex; justify-content: space-between; align-items: center;
            background: #222; padding: 12px; margin-bottom: 10px; border-radius: 8px;
            border-left: 3px solid var(--primary-gold);
        }
        .data-info { display: flex; flex-direction: column; }
        .data-label { font-size: 0.7rem; color: var(--text-gray); }
        .data-value { font-size: 0.95rem; color: #fff; font-weight: 600; }
        .copy-btn { color: var(--primary-gold); cursor: pointer; padding: 5px; font-size: 1.1rem; }
        .copy-btn:active { color: #fff; }

        /* Submission Form */
        .submission-form { margin-top: 25px; border-top: 1px solid #333; padding-top: 20px; }
        .sub-header { font-size: 1rem; color: #fff; margin-bottom: 15px; text-align: center; }
        .inp-group { margin-bottom: 15px; }
        .inp-field { 
            width: 100%; padding: 12px; background: #000; border: 1px solid #444; 
            color: #fff; border-radius: 8px; outline: none; transition: 0.3s;
        }
        .inp-field:focus { border-color: var(--primary-gold); }
        .submit-btn {
            width: 100%; padding: 12px; background: var(--success); color: #000;
            font-weight: bold; border: none; border-radius: 8px; cursor: pointer;
        }

        /* State: Pending / Waiting */
        #pendingSection { display: none; text-align: center; padding: 50px 20px; }
        .pending-icon { font-size: 3rem; color: var(--warning); margin-bottom: 20px; }
        
        /* Modal for Copy */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: var(--primary-gold); padding: 10px 20px;
            border-radius: 20px; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .toast.show { opacity: 1; bottom: 50px; }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <a href="home.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="title">GMAIL TASK ROOM</div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-box s-success">
            <span class="stat-val" id="countSuccess">0</span>
            <span class="stat-label">Successful</span>
        </div>
        <div class="stat-box s-failed">
            <span class="stat-val" id="countFailed">0</span>
            <span class="stat-label">Failed</span>
        </div>
        <div class="stat-box s-pending">
            <span class="stat-val" id="countPending">0</span>
            <span class="stat-label">Pending</span>
        </div>
        <div class="stat-box s-missing">
            <span class="stat-val" id="countMissing">0</span>
            <span class="stat-label">Missing</span>
        </div>
    </div>

    <!-- Task Container -->
    <div class="task-container">
        
        <!-- SECTION 1: APPLY / GET TASK -->
        <div id="applySection">
            <div style="margin-bottom: 20px; color: #888; font-size: 0.9rem;">
                Click apply to receive a new Gmail Task.<br>You have 13 minutes to complete.
            </div>
            <button class="apply-btn" onclick="applyForTask()">
                <i class="fas fa-play-circle"></i> APPLY NOW
            </button>
            <div id="searchingMsg" class="loader-text">
                <i class="fas fa-spinner fa-spin"></i> Finding Task from Admin...
            </div>
        </div>

        <!-- SECTION 2: ACTIVE TASK DISPLAY -->
        <div id="activeTaskSection">
            <div class="timer-box">
                <span class="timer-label">Time Remaining:</span>
                <span class="timer-count" id="timerDisplay">13:00</span>
            </div>

            <!-- Dynamic Data Fields -->
            <div id="taskDataList">
                <!-- Fields will be injected here via JS -->
            </div>

            <!-- Submission -->
            <div class="submission-form">
                <div class="sub-header">SUBMIT WORK PROOF</div>
                <div class="inp-group">
                    <input type="email" id="submitEmail" class="inp-field" placeholder="Created Email Address">
                </div>
                <div class="inp-group">
                    <input type="text" id="submitPass" class="inp-field" placeholder="Password Used">
                </div>
                <button class="submit-btn" onclick="submitTask()">SUBMIT TASK</button>
            </div>
        </div>

        <!-- SECTION 3: PENDING VIEW -->
        <div id="pendingSection">
            <i class="fas fa-clock pending-icon"></i>
            <h3>Submission Received</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-top:10px;">
                Admin is reviewing your task.<br>Please wait for approval.
            </p>
            <button onclick="checkStatus()" style="margin-top:20px; background:none; border:1px solid #555; color:#fff; padding:10px 20px; border-radius:5px;">Refresh Status</button>
        </div>

    </div>

    <!-- Copy Toast -->
    <div id="toast" class="toast">Copied to clipboard!</div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCMLtk6Nm4oK1Rt6InUQ4EeWFC3mTBeaA",
            authDomain: "task-elite.firebaseapp.com",
            databaseURL: "https://task-elite-default-rtdb.firebaseio.com",
            projectId: "task-elite",
            storageBucket: "task-elite.firebasestorage.app",
            messagingSenderId: "352060113315",
            appId: "1:352060113315:web:c44977d17cf7bab791da16"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let timerInterval = null;
        let currentTaskData = null;

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadStats();
                checkCurrentTask();
            } else {
                window.location.href = "register_login.html";
            }
        });

        // --- LOAD STATS ---
        function loadStats() {
            const statsRef = ref(db, `users/${currentUser.uid}/task_stats`);
            onValue(statsRef, (snapshot) => {
                const data = snapshot.val() || { success: 0, failed: 0, pending: 0, missing: 0 };
                document.getElementById('countSuccess').innerText = data.success;
                document.getElementById('countFailed').innerText = data.failed;
                document.getElementById('countPending').innerText = data.pending;
                document.getElementById('countMissing').innerText = data.missing;
            });
        }

        // --- CHECK CURRENT TASK STATUS ---
        function checkCurrentTask() {
            const taskRef = ref(db, `users/${currentUser.uid}/current_task`);
            onValue(taskRef, (snapshot) => {
                const task = snapshot.val();
                
                // Clear UI States
                document.getElementById('applySection').style.display = 'none';
                document.getElementById('activeTaskSection').style.display = 'none';
                document.getElementById('pendingSection').style.display = 'none';

                if (!task || task.status === 'idle') {
                    // Show Apply Button
                    document.getElementById('applySection').style.display = 'block';
                    document.getElementById('searchingMsg').style.display = 'none';
                } 
                else if (task.status === 'searching') {
                     // Searching State
                     document.getElementById('applySection').style.display = 'block';
                     document.getElementById('searchingMsg').style.display = 'block';
                     document.querySelector('.apply-btn').style.display = 'none';
                }
                else if (task.status === 'active') {
                    // Check Timer
                    const now = Date.now();
                    if (now > task.expiresAt) {
                        handleTaskMissing();
                    } else {
                        currentTaskData = task.data;
                        renderTaskData(task.data);
                        document.getElementById('activeTaskSection').style.display = 'block';
                        startTimer(task.expiresAt);
                    }
                } 
                else if (task.status === 'submitted') {
                    // Show Pending Msg
                    document.getElementById('pendingSection').style.display = 'block';
                }
            });
        }

        // --- APPLY FOR TASK ---
        window.applyForTask = () => {
            document.querySelector('.apply-btn').style.display = 'none';
            document.getElementById('searchingMsg').style.display = 'block';

            // Set status to searching in DB
            update(ref(db, `users/${currentUser.uid}/current_task`), {
                status: 'searching'
            });

            // ⚠️ SIMULATION: Normally Admin assigns this. 
            // Here, we simulate Admin assigning a task after 3 seconds for demo.
            setTimeout(() => {
                const fakeTask = {
                    firstName: "Rahim",
                    lastName: "Uddin",
                    password: "TaskPassword2024",
                    birthdate: "12/05/1998",
                    email: "requested.username12",
                    recoveryEmail: "", // Empty to test hiding
                };
                
                // Admin assigns task (Update DB)
                const expiresAt = Date.now() + (13 * 60 * 1000); // 13 mins from now
                set(ref(db, `users/${currentUser.uid}/current_task`), {
                    status: 'active',
                    expiresAt: expiresAt,
                    data: fakeTask
                });
            }, 3000);
        };

        // --- RENDER TASK DATA ---
        function renderTaskData(data) {
            const container = document.getElementById('taskDataList');
            container.innerHTML = ''; // Clear prev

            const fields = [
                { key: 'firstName', label: 'First Name' },
                { key: 'lastName', label: 'Last Name' },
                { key: 'password', label: 'Password' },
                { key: 'birthdate', label: 'Birthdate' },
                { key: 'email', label: 'Requested Email User' },
                { key: 'recoveryEmail', label: 'Recovery Email' }
            ];

            fields.forEach(field => {
                if (data[field.key] && data[field.key] !== "") {
                    const html = `
                        <div class="data-row">
                            <div class="data-info">
                                <span class="data-label">${field.label}</span>
                                <span class="data-value" id="val-${field.key}">${data[field.key]}</span>
                            </div>
                            <div class="copy-btn" onclick="copyText('val-${field.key}')">
                                <i class="far fa-copy"></i>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                }
            });
        }

        // --- TIMER LOGIC ---
        function startTimer(endTime) {
            if (timerInterval) clearInterval(timerInterval);
            
            function updateTimer() {
                const now = Date.now();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timerDisplay').innerText = "00:00";
                    handleTaskMissing();
                    return;
                }

                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById('timerDisplay').innerText = 
                    (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
            }

            updateTimer(); // Run once immediately
            timerInterval = setInterval(updateTimer, 1000);
        }

        // --- HANDLE MISSING TASK ---
        async function handleTaskMissing() {
            // Update stats
            const statsRef = ref(db, `users/${currentUser.uid}/task_stats`);
            const snapshot = await get(statsRef);
            let stats = snapshot.val() || { missing: 0 };
            stats.missing = (stats.missing || 0) + 1;
            
            await update(statsRef, { missing: stats.missing });
            
            // Reset Task Status
            await update(ref(db, `users/${currentUser.uid}/current_task`), {
                status: 'idle',
                data: null,
                expiresAt: 0
            });

            alert("Time Expired! Task marked as Missing.");
        }

        // --- SUBMIT TASK ---
        window.submitTask = async () => {
            const email = document.getElementById('submitEmail').value;
            const pass = document.getElementById('submitPass').value;

            if (!email || !pass) {
                alert("Please fill both Email and Password fields.");
                return;
            }

            // Update Status to Submitted
            await update(ref(db, `users/${currentUser.uid}/current_task`), {
                status: 'submitted',
                submission: {
                    email: email,
                    password: pass,
                    submittedAt: Date.now()
                }
            });
            
            // Increment Pending Count (Optimistic update)
            const statsRef = ref(db, `users/${currentUser.uid}/task_stats`);
            const snapshot = await get(statsRef);
            let stats = snapshot.val() || { pending: 0 };
            update(statsRef, { pending: (stats.pending || 0) + 1 });
        };

        // --- COPY FUNCTION ---
        window.copyText = (elementId) => {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        };

        window.checkStatus = () => {
            window.location.reload();
        };

    </script>
</body>
</html>
