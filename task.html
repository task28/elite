<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task28 Elite - Work Area</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --gold: #FFD700;
            --dark: #0a0a0a;
            --card: #161616;
            --text: #e0e0e0;
            --red: #ff4444;
            --green: #00C851;
            --blue: #33b5e5;
            --orange: #ffbb33;
        }

        body {
            background-color: var(--dark);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding-bottom: 50px;
        }

        /* --- HEADER & STATS --- */
        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            background: rgba(22,22,22,0.9);
        }
        .title { color: var(--gold); font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
        }
        .stat-box {
            background: var(--card);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }
        .stat-count { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.7; }
        
        /* Color Accents */
        .s-success { border-bottom: 3px solid var(--green); color: var(--green); }
        .s-pending { border-bottom: 3px solid var(--blue); color: var(--blue); }
        .s-failed { border-bottom: 3px solid var(--red); color: var(--red); }
        .s-missed { border-bottom: 3px solid var(--orange); color: var(--orange); }

        /* --- MAIN TASK CARD --- */
        .task-container {
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #333;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Request Button */
        .req-btn {
            background: linear-gradient(45deg, var(--gold), #ffaa00);
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            color: black;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
        }
        
        /* Loading Animation */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .wait-text { color: #888; font-size: 0.9rem; }

        /* --- ACTIVE TASK UI --- */
        .timer-box {
            font-size: 2rem;
            font-weight: bold;
            color: var(--red);
            background: #220000;
            padding: 10px 30px;
            border-radius: 10px;
            border: 1px solid var(--red);
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .details-box {
            width: 100%;
            text-align: left;
        }

        .data-row {
            background: #222;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--gold);
        }

        .data-label { font-size: 0.75rem; color: #888; display: block; }
        .data-val { font-size: 1rem; color: #fff; font-weight: 500; word-break: break-all; }
        
        .copy-btn {
            background: transparent;
            border: 1px solid #444;
            color: var(--gold);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .copy-btn:active { background: var(--gold); color: black; }

        /* Submit Form */
        .submit-area {
            width: 100%;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        .inp-field {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Back Home */
        .back-home {
            margin-top: 20px;
            color: var(--gold);
            text-decoration: none;
            border: 1px solid var(--gold);
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">TASK ZONE</div>
    </div>

    <!-- Stats Counters -->
    <div class="stats-grid">
        <div class="stat-box s-success">
            <div class="stat-count" id="c-success">0</div>
            <div class="stat-label">Successful</div>
        </div>
        <div class="stat-box s-pending">
            <div class="stat-count" id="c-pending">0</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-box s-failed">
            <div class="stat-count" id="c-failed">0</div>
            <div class="stat-label">Failed</div>
        </div>
        <div class="stat-box s-missed">
            <div class="stat-count" id="c-missed">0</div>
            <div class="stat-label">Missed</div>
        </div>
    </div>

    <!-- Main Dynamic Area -->
    <div class="task-container" id="main-area">
        <div class="loader"></div>
        <div class="wait-text">Loading System...</div>
    </div>

    <div style="text-align: center;">
        <a href="home.html" class="back-home"><i class="fas fa-home"></i> Home</a>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXMFqxIe8IrZkzUx2YVMTvVXQmIAhtruc",
            authDomain: "love-1-6cdb1.firebaseapp.com",
            databaseURL: "https://love-1-6cdb1-default-rtdb.firebaseio.com",
            projectId: "love-1-6cdb1",
            storageBucket: "love-1-6cdb1.firebasestorage.app",
            messagingSenderId: "949848083048",
            appId: "1:949848083048:web:ced52526264da1dcf4c9dd"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let uid = null;
        let timerInterval = null;

        // --- AUTH & LISTENER ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                uid = user.uid;
                loadStats();
                listenTaskStatus();
            } else {
                window.location.href = "index.html";
            }
        });

        // 1. Load Counters
        function loadStats() {
            db.ref('users/' + uid + '/stats').on('value', (snap) => {
                const s = snap.val() || { success: 0, pending: 0, failed: 0, missed: 0 };
                document.getElementById('c-success').innerText = s.success;
                document.getElementById('c-pending').innerText = s.pending;
                document.getElementById('c-failed').innerText = s.failed;
                document.getElementById('c-missed').innerText = s.missed;
            });
        }

        // 2. Main Logic Listener
        function listenTaskStatus() {
            db.ref('tasks/' + uid).on('value', (snap) => {
                const task = snap.val();
                const container = document.getElementById('main-area');
                
                if (!task || task.status === 'idle') {
                    // Show Request Button
                    container.innerHTML = `<button class="req-btn" onclick="requestTask()">GET NEW TASK</button>`;
                    stopTimer();

                } else if (task.status === 'requested') {
                    // Waiting for Admin
                    container.innerHTML = `
                        <div class="loader"></div>
                        <div class="wait-text">Searching for Task...<br>Please Wait for Admin</div>
                    `;
                    stopTimer();

                } else if (task.status === 'assigned') {
                    // Task Active - Show Timer & Data
                    renderActiveTask(task);

                } else if (task.status === 'submitted') {
                    // Pending Approval
                    container.innerHTML = `
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--blue); margin-bottom: 10px;"></i>
                        <h3 style="color: var(--blue);">Submitted!</h3>
                        <p style="text-align: center; color: #888;">Wait for admin approval.<br>Status: PENDING</p>
                        <button class="req-btn" onclick="requestTask()" style="font-size:0.9rem; padding:10px;">Apply for Next</button>
                    `;
                    stopTimer();
                } else if (task.status === 'expired') {
                    container.innerHTML = `
                         <i class="fas fa-times-circle" style="font-size: 3rem; color: var(--orange); margin-bottom: 10px;"></i>
                         <h3 style="color: var(--orange);">Time Expired!</h3>
                         <button class="req-btn" onclick="requestTask()">Try Again</button>
                    `;
                    stopTimer();
                }
            });
        }

        // 3. Helper Functions
        function requestTask() {
            db.ref('tasks/' + uid).update({
                status: 'requested',
                reqTime: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function renderActiveTask(task) {
            const container = document.getElementById('main-area');
            
            // 13 Minutes Logic
            const startTime = task.timestamp; // Admin sets this when assigning
            const duration = 13 * 60 * 1000; // 13 minutes in ms
            const endTime = startTime + duration;

            // Generate Dynamic HTML for Data Fields
            let html = `<div id="timer" class="timer-box">13:00</div>`;
            html += `<div class="details-box">`;

            // Mapping friendly names
            const labels = {
                firstName: "First Name",
                lastName: "Last Name",
                password: "Password",
                birthdate: "Birthdate",
                email: "Email (Pattern)",
                recovery: "Recovery Email"
            };

            // Only show keys that exist in task.data
            for (const [key, value] of Object.entries(task.data)) {
                if(value && labels[key]) {
                    html += `
                        <div class="data-row">
                            <div>
                                <span class="data-label">${labels[key]}</span>
                                <span class="data-val" id="val_${key}">${value}</span>
                            </div>
                            <button class="copy-btn" onclick="copyText('val_${key}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    `;
                }
            }
            html += `</div>`; // End details box

            // Submission Form
            html += `
                <div class="submit-area">
                    <p style="font-size:0.8rem; color:#888;">Create the Gmail & Submit here:</p>
                    <input type="text" id="sub_email" class="inp-field" placeholder="Created Email Address">
                    <button class="submit-btn" onclick="submitTask()">SUBMIT TASK</button>
                </div>
            `;

            container.innerHTML = html;

            // Start Timer
            startTimer(endTime);
        }

        // 4. Timer Logic
        function startTimer(endTime) {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer').innerHTML = "00:00";
                    handleTimeout(); // Task Missed
                    return;
                }

                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const minStr = minutes < 10 ? "0" + minutes : minutes;
                const secStr = seconds < 10 ? "0" + seconds : seconds;
                
                const timerEl = document.getElementById('timer');
                if(timerEl) timerEl.innerHTML = minStr + ":" + secStr;
            }, 1000);
        }

        function stopTimer() {
            if(timerInterval) clearInterval(timerInterval);
        }

        // 5. Actions
        function copyText(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const btn = document.getElementById(elementId).parentElement.parentElement.querySelector('.copy-btn');
                const original = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-check"></i>`;
                setTimeout(() => btn.innerHTML = original, 1500);
            });
        }

        function submitTask() {
            const email = document.getElementById('sub_email').value;
            if(!email) { alert("Please enter the created email!"); return; }

            // Update Task Status
            db.ref('tasks/' + uid).update({
                status: 'submitted',
                submissionTime: firebase.database.ServerValue.TIMESTAMP,
                submittedData: email
            });

            // Update User Pending Counter (Locally or trigger cloud function)
            // For now, simple increment in DB
            db.ref('users/' + uid + '/stats/pending').transaction(count => (count || 0) + 1);
        }

        function handleTimeout() {
            // Check if already submitted to avoid conflict
            db.ref('tasks/' + uid).once('value', snap => {
                const t = snap.val();
                if(t.status === 'assigned') {
                    db.ref('tasks/' + uid).update({ status: 'expired' });
                    db.ref('users/' + uid + '/stats/missed').transaction(c => (c || 0) + 1);
                }
            });
        }

    </script>
</body>
</html>
